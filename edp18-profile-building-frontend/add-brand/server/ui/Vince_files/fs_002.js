/***************************************
* @preserve
* ForeSee Web SDK: Trigger
* Built June 01, 18 13:03:06
* Code version: 19.6.8
* Template version: 19.6.8
***************************************/
_fsDefine(["require","fs",_fsNormalizeUrl("$fs.utils.js"),"triggerconfig"],function(e,t,i,config){var r={loadedEmitter:new i.FSEvent,initializedEmitter:new i.FSEvent,inviteShownEmitter:new i.FSEvent,inviteAcceptedEmitter:new i.FSEvent,inviteAbandonedEmitter:new i.FSEvent,inviteDeclinedEmitter:new i.FSEvent,trackerShownEmitter:new i.FSEvent,customInvitationRequested:new i.FSEvent,CPPS:null,_triggerResetLock:null,state:{didInvite:!1},inviteSetup:null},n={INVITE_SHOWN:"fs_inviteShown",INVITE_ACCEPTED:"fs_inviteAccepted",INVITE_DECLINED:"fs_inviteDeclined",INVITE_ABANDONED:"fs_inviteAbandoned",LINKS_CANCEL:"fs_linksCancel",TRACKER_SHOWN:"fs_trackerShown",TRACKER_CLICKED:"fs_trackerClicked",QUALIFIER_ACCEPTED:"fs_qualifierAccepted",QUALIFIER_DECLINED:"fs_qualifierDeclined",QUALIFIER_SHOWN:"fs_qualifierShown",REMINDER_SHOWN:"fs_reminderShown",REMINDER_ACCEPTED:"fs_reminderAccepted"};if(config&&config.surveydefs)for(var s=0;s<config.surveydefs.length;s++)t.isString(config.surveydefs[s])&&(config.surveydefs[s]=i.compile(i.b64DecodeUnicode(config.surveydefs[s])));var o=window,a=new i.Cookie({path:"/",secure:!1,encode:!0}),c=i.Compress;if(t.fsCmd("fstest"))return void e([t.makeURI("$fs.svadmin.js")],function(e){});if(t.fsCmd("fsoptout"))return void e([t.makeURI("$fs.optout.js")],function(e){});var f=function(e,i,r,n,s,a){var c={width:700,height:350,left:50,top:50,resizable:"no",scrollbar:"1",scrollbars:"1",toolbar:"no",menubar:"no",location:"0",directories:"no",status:"no"},f=a?u(r.width||c.width,r.height||c.height):{},l=t.ext(c,r,f),d="";for(var g in l)d+=g+"="+l[g]+",";var p=this._win=o.open(e,i,d);if(p&&s)if(p.blur(),p.opener.window.focus(),o.focus(),"Firefox"==n.browser.name){var h=o.open("about:blank");h.focus(),h.close()}else n.isIE&&setTimeout(function(){p.blur(),p.opener.window.focus(),o.focus()},1e3);return p},u=function(e,t){var i=void 0!==window.screenLeft?window.screenLeft:screen.left,r=void 0!==window.screenTop?window.screenTop:screen.top,n=window.innerWidth;window.innerWidth||(n=document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width);var s=window.innerHeight;return window.innerHeight||(s=document.documentElement.clientHeight?document.documentElement.clientHeight:screen.Height),{left:n/2-e/2+i,top:s/2-t/2+r}},l=config.config.surveyAsyncCurl,d={SERVICE_TYPES:{mobileOnExitInitialize:{host:l,path:"/e",url:"/initialize"},mobileOnExitHeartbeat:{host:l,path:"/e",url:"/recordHeartbeat"}}};d.ping=function(e,t,r,n){var s=new i.ImageTransport,o="https://"+e.host+e.path+(e.url||"");s.send({url:o,success:r||function(){},failure:n||function(){},data:t})};var g=function(e,t,i,n,s,o,a,c){return r.inviteSetup?c.call(r.inviteSetup):r.inviteSetup=new p(e,t,i,n,s,o,a,c),r.inviteSetup},p=function(n,s,o,a,c,f,u,l){if(this.trig=n,this.browser=s,this.stg=o,this.cpps=a,this.displayoverride=c,this.jrny=f,this.resourcesready=new i.FSEvent,this.triggerMethod=u,t.isDefined(this.trig.surveydef.inviteExclude)&&t.isDefined(this.trig.crit)&&this.trig.crit.runAllTests(this.trig.surveydef.inviteExclude,this.browser,!1,!0))return!1;var d=this;fsReady(function(){var i;if(n.invite&&n.invite.dispose(),s.isMobile&&n.cfg.config.pagesInviteAvailable)if(null===(i=o.get("pia")))o.set("pia",--n.cfg.config.pagesInviteAvailable);else if(i>0)o.set("pia",--i);else if(0===i)return;e([t.makeURI("$fs.invite.js")],function(e){var t=d.invite=n.invite=new e(config,n.surveydef,s,c,a,r);o.set("dn",t.display.displayname),a.set("dn",t.display.displayname),l&&l.call(d)}.bind(this))})},h=function(e,t,i){var r=new T(i,config,e.surveydef,e.cpps,e.stg.get("rid"),e.locale);e.stg.get("mhbi")?r.beginHeartbeat():r.init(t,function(){r.beginHeartbeat()})};p.prototype.initialize=function(){var e=this.trig,s=(this.browser,this.stg),o=this.cpps,a=(this.displayoverride,this.invite),c=this.jrny;this.didInitialize||(this.didInitialize=!0,c.addEventsDefault("properties",{fs_defName:[e.surveydef.name],fs_section:[e.surveydef.section],fs_displayName:[a.display.displayname],fs_pvInvited:[e.pageViewCount],fs_language:[a.locale],fs_samplePercentage:[e.surveydef.criteria.sp.reg],fs_loyaltyFactor:[e.surveydef.criteria.lf],fs_environment:[t.isProduction?"production":"staging"],fs_deployType:[t.isSelfHosted?"on-prem":"cloud"],fs_inviteType:["intercept"],fs_triggerMethod:[this.triggerMethod]}),o.set("TriggerMethod",this.triggerMethod),a.loadResources(this.resourcesready),a.declined.subscribe(function(i){var a=t.isDefined(config.active_surveydef)&&t.isDefined(config.active_surveydef.repeatDays)?config.active_surveydef.repeatDays:config.config.repeatDays;s.set("i","d"),s.setMaxKeyExpiration(24*a.decline*60*60*1e3),c.addEventObj({name:n.INVITE_DECLINED,properties:{action:[i]}}),r.inviteDeclinedEmitter.fire(e.surveydef,s,config,o),e.surveydef.cxRecord&&r.rec&&"y"!=s.get("fbr")&&(r.rec.cancelRecord(),e.recordController=r.rec=null),r.state.inviteSituation="DECLINED"}),a.abandoned.subscribe(function(){c.addEventString(n.INVITE_ABANDONED),s.set("i","a"),r.state.inviteSituation="ABANDONED",r.inviteAbandonedEmitter.fire(e.surveydef,s,config,o),s.set("rw",i.now()+config.config.reinviteDelayAfterInviteAbandon)}),a.accepted.subscribe(function(f,u){var l=t.isDefined(config.active_surveydef)&&t.isDefined(config.active_surveydef.repeatDays)?config.active_surveydef.repeatDays:config.config.repeatDays;switch(s.setMaxKeyExpiration(24*l.accept*60*60*1e3),r.inviteAcceptedEmitter.fire(e.surveydef,s,config,o),e.surveydef.cxRecord&&r.rec&&r.rec.recorder&&r.rec.beginTransmitting(),c.addEventString(n.INVITE_ACCEPTED),s.set("i","x"),r.state.inviteSituation="ACCEPTED",s.set("ixw",i.now()),f){case"TRACKER":e.popTracker(a);break;case"INSESSION":e.popSurvey();break;case"SMS":case"EMAIL":case"SMSEMAIL":h(e,u,f),e.stg.set("mhbi",{ui:u,it:f})}}))},p.prototype.present=function(){var e=(this.invite,this.stg),s=this.jrny,o=this.trig,a=this.cpps;r.state.didInvite||(r.state.didInvite=!0,this.resourcesready.subscribe(function(){setTimeout(function(){this.invite.present(),"p"!==e.get("i")&&s.addEvent(n.INVITE_SHOWN),e.set("i","p"),r.state.inviteSituation="PRESENTED",r.inviteShownEmitter.fire(o.surveydef,e,config,a)}.bind(this),Math.max(0,config.config.inviteDelay-(i.now()-t.startTS)))}.bind(this),!0,!0))};var v=function(e,n,s,a,c,f,u){r.tracker&&(r.tracker.dispose(),r.tracker=null),r.tracker=this,t.ext(this,{template:e,def:n,cfg:s,disp:f,_fcBindings:[]}),this.cpps=c,this.br=u,this.stg=a,this.forceLong=!1,e&&r.trackerShownEmitter.fire(n,a,s,c);var l=t.proxy(function(e){this.stg.set("page_hb",i.now(),this.forceLong?s.config.trackerHeartbeatLongTimeout:s.config.trackerHeartbeatTimeout,!e)},this);this._heartbeat=setInterval(l,Math.round(.5*s.config.trackerHeartbeatTimeout)),l(!0),i.Bind(o,"unload",t.proxy(function(){this.forceLong=!0,this.stg.set("page_hb",i.now(),s.config.trackerHeartbeatLongTimeout,!0)},this));var d=t.enc;this._url=t.makeURI("$fs.tracker.html?uid="+d(a.uid||"")+"&sitekey="+d(t.config.siteKey)+"&domain="+d(i.getRootDomain())+"&gw="+d(t.makeURI("trigger/__gwtest__"))+"&brain_url="+d(t.config.brainUrl)+"&fsrlocale="+d(c.get("locale")||"en")+"&_svu_="+d(t.config.surveyUrl)+"&_cv_="+d(t.config.codeVer)+"&_issh_="+d(t.isSelfHosted)+"&_vt_="+d(t.tagVersion)+"&_au_="+d(t.config.analyticsUrl)+"&_pa_="+d(t.assetLocation)),this.cpps.onSet.subscribe(t.proxy(function(e,t){var i={};i[e]=t,this.stg.set("ckcpps",i,2e5,!1)},this)),this.stg.set("ckcpps",this.cpps.all(),2e5,!1),this._sendDefinition()};v.prototype._sendDefinition=function(){var e={method:"init",cfg:t.ext({},this.cfg,{globalConfig:t.config})};this.disp&&(e.display=this.disp),this.template&&(e.template=this.template),e.hb_i=this.cfg.config.trackerHeartbeatTimeout,e.cpps=this.cpps.all(),this.stg.set("page_hb",i.now(),this.cfg.config.trackerHeartbeatTimeout,!1),this.stg.set("trackerinfo",e,6e4,!1),this.stg.set("ckcpps",this.cpps.all(),2e5,!1)},v.prototype.show=function(e){this.wref=f(this._url,"fsTracker",{width:700,height:450},e,!0,this.cfg.config.centerTrackerPopup)},v.prototype.applyExisting=function(e,t){this.wref=t,t.location=this._url},v.prototype.dispose=function(){for(var e=0;e<this._fcBindings.length;e++)this._fcBindings[e].unsubscribe();this.stg=null,clearInterval(this._heartbeat)};var y=function(config,e,i,r){this.cfg=config,this.globalConfig=config.globalConfig||t.config,this.cpps=e,this.def=i,this.locale=e.get("locale")||"en",this.qual=r},m=function(e,t){var i,r,config,n=t.name||"";for(n+="-"+(t.section||""),n+="-"+(t.site||""),i=0;i<e.defs.length;i++)if(config=e.defs[i],r=config.name||"",r+="-"+(config.section||""),(r+="-"+(config.site||""))===n)return config;return null};y.prototype.decideModernSurvey=function(){var e=this.cfg.config.abSurveyType,t=e&&e.shouldTest&&this.globalConfig.modernSurveyUrl,i=t&&m(e,this.def);return this.cfg.config.onlyModernSurvey?{modernChosen:!0,modernPercentage:100}:i?{modernChosen:i.modernPercentage>=Math.floor(100*Math.random()),modernPercentage:i.modernPercentage}:{modernChosen:!1,modernPercentage:0}},y.prototype.getUrl=function(){var e,r=this.def,n=i.now()+"_"+Math.round(1e13*Math.random()),s=r.name+"-"+(t.isDefined(r.site)?r.site+"-":"")+(t.isDefined(r.section)?this.def.section+"-":"")+this.locale,o=this.decideModernSurvey();this.qual&&(s+="-"+this.qual.qualifiesValue);var a={sid:s,cid:this.cfg.config.id,pattern:this.cpps.get(r.pattern)||r.pattern,a:n,b:i.hash(n),c:864e5,mp:o.modernPercentage};e=o.modernChosen?this.globalConfig.modernSurveyUrl:this.globalConfig.surveyUrl,e+="?";for(var c in a)e+=t.enc(c)+"="+t.enc(a[c])+"&";return e+=this.cpps.toQueryString()};var b=function(e,config){this.stg=e,this.cfg=config};b.prototype.calcReplayPoolStatus=function(e){var r,n,s,a=this.cfg.config,c=a.replay_pools,f=o.location.toString();if(c&&0!==c.length&&!0!==this.pooloverride){if(n=this.stg.get("pl"),!t.isDefined(n))for(r=0;r<c.length;r++)i.testAgainstSearch(c[r].path,f)&&(n=100*Math.random()<c[r].sp?1:0,this.stg.set("pl",n,144e5));if(s=a.replay_repools,0===n&&s&&s.length>0)for(r=0;r<s.length;r++)i.testAgainstSearch(s[r].path,f)&&(n=100*Math.random()<s[r].sp?1:0,this.stg.set("pl",n,144e5));e(!!n)}else e(!0)},b.prototype.optoutCheck=function(e,i){this.stg.ready.subscribe(t.proxy(function(){!0===this.stg.get("optout")?i():e()},this),!0,!0)},b.prototype.browserCheck=function(e,t){return!(!e.isMobile&&t.config.browser_cutoff[e.browser.name]&&e.browser.actualVersion<t.config.browser_cutoff[e.browser.name])},b.prototype.featureCheck=function(e,t){return!(t.config.persistence==i.storageTypes.DS&&!e.supportsLocalStorage)},b.prototype.platformCheck=function(e,t){return!(t.config.platform_cutoff[e.os.name]&&e.os.version<t.config.platform_cutoff[e.os.name])},b.prototype.checkDeviceBlacklist=function(e,i){for(var r=0;r<i.config.device_blacklist.length;r++)if(t.toLowerCase(e.agent).indexOf(t.toLowerCase(i.config.device_blacklist[r]))>-1)return!1;return!0},b.prototype._match=function(e,t,i){var r=e.include,n=e[i||"globalExclude"];if(e.criteria){if(!e.criteria.supportsSmartPhones&&!t.isTablet&&t.isMobile)return!1;if(!e.criteria.supportsTablets&&t.isTablet)return!1;if(!e.criteria.supportsDesktop&&!t.isMobile)return!1}if(n){if(this.runAllTests(n,t,!1,!0))return!1}return!r||this.runAllTests(r,t,!1,!0)},b.prototype.runAllTests=function(e,r,n,s){var a,c=new i.Cookie({}),f=o.location.href.toString(),u=document.referrer.toString(),l={urls:f,referrers:u,userAgents:o.navigator.userAgent};for(var d in e){var g=e[d];if(g.length>0){if(a=!1,l[d])a=function(e,t){Array.isArray(t)||(t=[t]);for(var r=0,n=t.length;r<n;r++)if("string"==typeof t[r]&&(t[r]=t[r].replace(/-_DS_-/gi,"$")),i.testAgainstSearch(t[r],e))return!0;return!1}(l[d],g);else if("browsers"==d)for(var p=r.browser.name,h=r.browser.actualVersion,v=0;v<g.length;v++)t.toLowerCase(p).indexOf(t.toLowerCase(g[v].name))>-1&&(g[v].comparison?"lt"==g[v].comparison&&h<g[v].version?a=!0:"eq"==g[v].comparison&&h==g[v].version?a=!0:"gt"==g[v].comparison&&h>g[v].version&&(a=!0):a=!0);else if("cookies"==d)for(var y=0;y<g.length;y++){var m=g[y],b=c.get(m.name);t.isDefined(m.value)&&b==m.value?a=!0:!t.isDefined(m.value)&&b&&(a=!0)}else if("variables"==d)for(var w=0;w<g.length;w++){var S=[].constructor.constructor;delete[].constructor.constructor;var _,I=g[w],E=new[].constructor.constructor("var v1 = '';try { v1 = "+I.name+";}catch(err) {}return v1;"),k=E.call(o);[].constructor.constructor=S,k||(k="boolean"!=typeof k&&""),_=t.isDefined(I.value),_&&k===I.value?a=!0:_&&i.testAgainstSearch(I.value,k)?a=!0:!_&&k&&(a=!0)}if(!a&&n)return!0;if(a&&s)return!0}}return!1};var w=function(e){this.cfg=e};w.prototype._bindToLink=function(e,r){for(var n=document.querySelectorAll(e.selector),s=0;s<n.length;s++){var o,a=n[s],c=!0;if(e.attribute&&(o=a.getAttribute(e.attribute),c=!1,o&&(c=!0,e.patterns&&e.patterns.length>0))){c=!1;for(var f=0;f<e.patterns.length;f++)if(t.toLowerCase(o).indexOf(t.toLowerCase(e.patterns[f]))>-1){c=!0;break}}c&&i.Bind(a,"trigger:click",function(e,t,r){return function(n){t.preventDefault&&i.preventDefault(n),r.call(e,t)}}(this,e,r))}},w.prototype.performBindings=function(e){if(e&&this.cfg){var t,i=this.cfg;if(i.cancel&&i.cancel.length>0){var r=function(){e.cancelTracker(),e.jrny.addEventString(n.LINKS_CANCEL)};for(t=0;t<i.cancel.length;t++)this._bindToLink(i.cancel[t],r)}if(i.survey&&i.survey.length>0){var s=function(){e.popSurvey()};for(t=0;t<i.survey.length;t++)this._bindToLink(i.survey[t],s)}if(!e.browser.isMobile&&i.tracker&&i.tracker.length>0){var o=function(){e.popTracker()};for(t=0;t<i.tracker.length;t++)this._bindToLink(i.tracker[t],o)}}};var S,_=new i.FSEvent;t.API.expose("CPPS",{set:function(){_.subscribe(function(e){return function(){r.CPPS.set.apply(r.CPPS,e)}}(arguments),!0,!0)},get:function(e,t){t=t||function(){},_.subscribe(function(e){return function(){t(r.CPPS.get.apply(r.CPPS,e[0]))}}([arguments]),!0,!0)},all:function(e){e=e||function(){},_.subscribe(function(t){return function(){e(r.CPPS.all.apply(r.CPPS))}}(),!0,!0)}}),t.API.expose("clearState",function(){_.subscribe(function(){r.tracker&&r.tracker._heartbeat&&clearInterval(r.tracker._heartbeat),r.stg.reset(),t.supportsDomStorage&&sessionStorage.removeItem("acsFeedbackSubmitted"),r.rec&&r.rec.recorder&&r.rec.recorder.clearState()},!0,!0)}),t.API.expose("dispose",function(){_.subscribe(function(){r.trig&&r.trig.dispose()},!0,!0)}),t.API.expose("getState",function(e){_.subscribe(function(){e(r.state)},!0,!0)}),t.API.expose("getConfig",function(){return t.ext({},config,{global:t.config})}),t.API.expose("getConfigFormatted",function(){if(console&&console.info&&(console.info("************************** Trigger Configuration **************************"),console.info("Config: ",config.config),config.surveydefs&&config.surveydefs.length)){console.info("************************** Surveydefs Configuration **************************");for(var e=0;e<config.surveydefs.length;e++)console.info("************************** Surveydef "+(e+1)+" **************************"),console.info("Config: ",config.surveydefs[e])}}),t.API.expose("optOut",function(){var e=o.location.toString();o.location=e.indexOf("#")?e.substr(0,e.indexOf("#")-1)+"#fscommand=fsoptout":e+"#fscommand=fsoptout",o.location.reload()}),t.API.expose("test",function(){var e=o.location.toString();o.location=e.indexOf("#")?e.substr(0,e.indexOf("#")-1)+"#fscommand=fstest":e+"#fscommand=fstest",o.location.reload()});var I=function(){_.subscribe(function(){S&&(clearTimeout(S),S=null),S=setTimeout(function(){if(S=null,!r._triggerResetLock){r._triggerResetLock=!0;var e=r.trig;e&&(e.dispose(),r.trig=null),t.startTS=i.now(),t.nextTick(function(){R()})}},250)},!0,!0)};t.API.expose("run",I),t.API.expose("pageReset",I),t.API.expose("showInvite",function(e){_.subscribe(function(){if(!document.getElementById("acsMainInvite")){var t=r.trig||D(r.stg,config,r.browser,r.crit,r.CPPS);if(t.init()&&t.doesPassCriteria()&&t.surveydef){r.state.didInvite=!1;g(t,r.browser,r.stg,r.CPPS,e,r.jrny,"Traditional",function(){this.initialize(),this.present()})}}},!0,!0)}),t.API.expose("onLoaded",r.loadedEmitter),t.API.expose("onInitialized",r.initializedEmitter),t.API.expose("onInviteShown",r.inviteShownEmitter),t.API.expose("onInviteAccepted",r.inviteAcceptedEmitter),t.API.expose("onInviteAbandoned",r.inviteAbandonedEmitter),t.API.expose("onInviteDeclined",r.inviteDeclinedEmitter),t.API.expose("onTrackerShown",r.trackerShownEmitter),t.API.expose("customInvitationRequested",r.customInvitationRequested),t.API.expose("Journey",{addEvent:function(){_.subscribe(function(e){return function(){r.jrny.addEvent.apply(r.jrny,e)}}(arguments),!0,!0)},addEventObj:function(){_.subscribe(function(e){return function(){r.jrny.addEventObj.apply(r.jrny,e)}}(arguments),!0,!0)},addEventString:function(){_.subscribe(function(e){return function(){r.jrny.addEventString.apply(r.jrny,e)}}(arguments),!0,!0)}}),t.API.expose("Storage",{get:function(e,t){t=t||function(){},_.subscribe(function(e){return function(){t(r.stg.get.apply(r.stg,e[0]))}}([arguments]),!0,!0)},all:function(e){e=e||function(){},_.subscribe(function(t){return function(){var t=r.stg.all();e(t)}}(),!0,!0)}}),t.API.expose("Cookie",{get:function(e,t){t=t||console.log||function(){},_.subscribe(function(e){return function(){try{t("_4c_"===e[0]?JSON.parse(c.decompress(decodeURIComponent(a.get(e[0])))):a.get(e[0]))}catch(t){console.error("trigger: couldn't read cookie",e[0])}}}(arguments),!0,!0)}});var E=function(e,i,n,s,o){t.ext(r,{CPPS:n,crit:i,stg:e,jrny:s,browser:o},!1),_.fire()},k=function(i,n,s,a,c,f){n&&a&&(t.isDefined(t.config.products.record)&&!1===t.config.products.record&&t.productConfig.record||e([t.makeURI("$fs.record.js")],function(e){s.set("rc","true");var t={id:config.config.id};r.RecordController=e,r.rec=e.getInstance(i,o,s,t,c),f&&(f.recordController=rec)}))},D=function(e,config,t,i,r,n){return new C(e,config,t,i,r,n)},C=function(e,r,n,s,o,a){this.stg=e,this.cfg=r,this.browser=n,this.crit=s,this.cpps=o,this.jrny=a;var c,f,u=t.config.adobeRsid;if(!e.get("pv")){c={browser:n.browser.name+" "+n.browser.version,fp:n.fp,os:n.os.name,referrer:document.referrer.toString(),site:i.getRootDomain(),sitekey:r.config.site_key||""};for(f in c)c.hasOwnProperty(f)&&o.set(f,c[f]);i.INT.GA.has()&&setTimeout(t.proxy(function(){i.INT.GA.uid(function(e){e&&o.set("GA_UID",e)})},this),2e3);var l=function(e){o.set(e.name,e.value)};u&&(i.INT.OM.uid(u,l),i.INT.OM.mcid(u,l));var d=i.INT.OM.beacon();d&&o.set("OMTR_BEACON",d)}this.heartbeatExpired=new i.FSEvent};C.prototype.doesPassCriteria=function(){var e=this.crit,t=this.cfg,i=r.state,n="DIDNOTPASSCRITERIA";if(e.platformCheck(this.browser,t))if(e.browserCheck(this.browser,t))if(e.checkDeviceBlacklist(this.browser,t)){if(e.featureCheck(this.browser,t))return!0;i.inviteStatus=n,i.reason="BROWSER"}else i.inviteStatus=n,i.reason="DEVICE";else i.inviteStatus=n,i.reason="BROWSER";else i.inviteStatus=n,i.reason="PLATFORM";return!1},C.prototype.popTracker=function(e){var t=this;if(this.stg.set("i","x"),r.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("dt"),r.state.didInvite=!0,!this.didPopTrackerAlready){this.stg.set("dt","y");if(e)!function(){t.tracker=new v(e.template,t.surveydef,config,i.getBrainStorage(t.browser,t.stg.uid),t.cpps,e.display,t.browser),t.tracker.show(t.browser)}();else{var n=f("about:blank","fsTracker",{width:700,height:400},this.browser,!0,this.cfg.config.centerTrackerPopup);g(this,t.browser,t.stg,t.cpps,!1,t.jrny,"Traditional",function(){t.tracker=new v(this.invite.template,t.surveydef,config,i.getBrainStorage(t.browser,t.stg.uid),t.cpps,this.invite.display,t.browser),t.tracker.applyExisting(t.browser,n),t.surveydef.cxRecord&&r.rec&&r.rec.recorder&&r.rec.beginTransmitting()})}}},C.prototype.canDisplayInvitation=function(){return this.crit._match(this.cfg.config,this.browser,"inviteExclude")},C.prototype.popSurvey=function(e){if(this.stg.set("i","x"),r.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("dt"),r.state.didInvite=!0,this.didPopTrackerAlready)this.stg&&i.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"survey"},6e4,!0);else{this.stg.set("dt","y");var t=new y(config,this.cpps,this.surveydef,null,e),n=t.getUrl();f(n,"acsSurvey",{width:700,height:400},this.browser,!1,this.cfg.config.centerTrackerPopup)}},C.prototype.init=function(){var e,i,r,n=this.cfg.surveydefs,s=this.stg.get("def");for(e=0;e<n.length;e++)r=n[e],i&&(r=t.ext(i,r),!n[e].site&&i.site&&delete r.site,!n[e].section&&i.section&&delete r.section,n[e]=r),i=t.ext({},r);if(t.isDefined(s)&&parseInt(s)>n.length-1&&(s=void 0),t.isDefined(s)&&"default"!=n[parseInt(s)].selectMode&&"pin"!=n[parseInt(s)].selectMode){if(t.isDefined(s)||"lock"==n[parseInt(s)].selectMode)return r=n[parseInt(s)],this.cfg.active_surveydef=r,this.surveydef=r,this._setupTrueConversionIfRequired(),this.locale=this._initLocale(),this.cpps.set("locale",this.locale),r.section&&this.cpps.set("section",r.section),r}else for(e=0;e<(t.isDefined(s)&&"default"!=n[parseInt(s)].selectMode?parseInt(s)+1:n.length);e++)if(r=n[e],t.isDefined(s)&&s==e&&"default"!=n[parseInt(s)].selectMode||this.crit._match(r,this.browser))return"x"===this.stg.get("i")&&this.stg.set("def",e,this.cfg.config.surveyDefResetTimeout||864e5),r.index=e,this.cfg.active_surveydef=r,this.surveydef=r,this._setupTrueConversionIfRequired(),this.locale=this._initLocale(),this.cpps.set("locale",this.locale),r.section&&this.cpps.set("section",r.section),this.inviteIndex=e,r;return!1},C.prototype._initLocale=function(){var e,r=this.surveydef,n=r.language;if(t.isDefined(n.src)&&t.isDefined(n.locales)){switch(n.src){case"variable":t.isDefined(n.name)&&(e=i.retrieveNestedVariable(window,n.name));break;case"cookie":if(t.isDefined(n.name)){e=new i.Cookie({}).get(n.name)}break;case"url":var s=n.locales;if(t.isDefined(s))for(var o=0,a=s.length;o<a;o++)if(t.isDefined(s[o].locale)&&t.isDefined(s[o].match)&&location.href.match(s[o].match))return this.locale=s[o].locale,s[o].criteria&&t.ext(this.surveydef.criteria,s[o].criteria),this.locale!==r.language.locale&&(r.language.locale=this.locale),s[o].locale}if(e)for(var c=0;c<n.locales.length;c++)if(n.locales[c].match==e)return n.locale=n.locales[c].locale,n.locales[c].criteria&&t.ext(this.surveydef.criteria,n.locales[c].criteria),n.locale}return n.locale||"en"},C.prototype.cancelTracker=function(){i.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"close"},6e4,!0),this.stg.set("i","a"),r.state.inviteSituation="ABANDONED",t.isDefined(this.tracker)&&clearInterval(this.tracker._heartbeat)},C.prototype._setupTrueConversionIfRequired=function(){var i=(this.surveydef,this.cfg.config);i.trueconversion&&i.trueconversion.enabled&&e([t.makeURI("$fs.trueconversion.js")],t.proxy(function(e){this.trueconversion=new e(this)},this))},C.prototype.logState=function(){this.pageViewCount=(this.stg.get("pv")||0)+1,this.stg.set("pv",this.pageViewCount,config.config.pageViewsResetTimeout||864e5)},C.prototype.logDefState=function(){if(this.surveydef){var e=this.surveydef.name;e+=this.surveydef.section||"",e+=this.surveydef.site||"",this.defPageViewCount=(this.stg.get(e+"pv")||0)+1,this.stg.set(e+"pv",this.defPageViewCount,config.config.pageViewsResetTimeout||864e5)}},C.prototype.evalLoyaltySampling=function(e){var i=this.surveydef,r=i[e]||i.criteria,n=this.stg.get("pl"),s=t.isDefined(n)&&1!=n?r.sp.outreplaypool||0:r.sp.reg||0,o=100*Math.random();return this.defPageViewCount>=r.lf&&o<=s},C.prototype.dispose=function(){this.disposed||(this.stg.save(!0),this.disposed=!0,this.trueconversion&&this.trueconversion.dispose(),this.invite&&this.invite.dispose(),delete r.inviteSetup,this.mouseoff&&this.mouseoff.dispose(),r.rec&&(r.RecordController.disposeInstance(),r.RecordController=null,r.rec=null),i.Unbind("trigger:*"))};var T=function(e,i,r,n,s,o){this.itype=e,this.cfg=i,this.def=r,this.cpps=n,this.rid=s,this._measureName=this.def.name+"-"+(t.isDefined(this.def.site)?this.def.site+"-":"")+(t.isDefined(this.def.section)?this.def.section+"-":"")+(o||this.def.language.locale)};T.prototype.init=function(e,r){r=r||function(){};var n=new y(this.cfg,this.cpps,this.def,null),s=n.decideModernSurvey(),o=i.now()+"_"+Math.round(1e13*Math.random()),a={a:o,notify:e,b:i.hash(o),c:864e5,cid:this.cfg.config.id,sid:this._measureName,rid:this.rid,uid:i.now(),support:"SMSEMAIL"==this.itype?"b":"EMAIL"==this.itype?"e":"s",cpps:"version="+encodeURIComponent(this.cfg.config.version)+"&"+this.cpps.toQueryString()};s.modernChosen&&(a=t.ext({fs_renderer:"modern"},a)),d.ping(d.SERVICE_TYPES.mobileOnExitInitialize,a,r,r)},T.prototype.beginHeartbeat=function(){this._timer&&(clearTimeout(this._timer),this._timer=null);var e=t.proxy(function(){d.ping(d.SERVICE_TYPES.mobileOnExitHeartbeat,{cid:this.cfg.config.id,sid:this._measureName,rid:this.rid,uid:i.now()},function(){},function(){})},this);this._timer=setInterval(e,config.config.onExitMobileHeartbeatInterval),e()},i.registerProduct("foresee",config);var A=window!=o.top;if(r.loadedEmitter.fire(),("dontRunOtherIframes"!==config.config.workInIframes&&config.config.workInIframes||!A)&&!(o.__fsrtracker||o.location.toString().indexOf("survey.foreseeresults.com")>-1)){var x={hash:o.location.hash,href:o.location.href,pathname:o.location.pathname},R=function(){if(r._triggerResetLock=!0,x.href.indexOf("fs.tracker.html")>-1)return void(r._triggerResetLock=!1);var n=new i.Browser;n.ready.subscribe(function(){var s,c=i.getGeneralStorage(n),f=new b(c,config),u=new i.CPPS(c,config.config.cppsResetTimeout);u.addToBlacklist(config.config.disable_default_cpps||config.config.disable_cpps||[]),u.set("url",o.location.toString()),c.ready.subscribe(t.proxy(function(){c.upgradeOldStorage(function(){var l=t.config.customerId||config.config.id||i.getRootDomain(),d=r._journey=new i.Journey(l,i.APPID.TRIGGER,c.uid,n,100);d.addEventsDefault("properties",{fs_site:[i.getRootDomain()],fs_repeatDaysAccept:[config.config.repeatDays.accept],fs_repeatDaysDecline:[config.config.repeatDays.decline],fs_reinviteDelayAfterInviteAbandon:[config.config.reinviteDelayAfterInviteAbandon]}),E(c,f,u,d,n);var p=c.get("i");setTimeout(t.proxy(function(){if(u.set("url",o.location.toString()),u.set("code",t.config.codeVer),u.set("tz",-(new Date).getTimezoneOffset()),u.set("product_type","web sdk"),config.config.cpps){var l,y,m=config.config.cpps;for(var b in m){var S=m[b];if(t.isObject(S))switch(S.source){case"param":var _=t.getParam(S.val)||S.init||null;if(t.isDefined(S.mode)&&"append"==S.mode){var I,E=S.delimiter||",",C=u.get(b),T=C?C.split(E):[];_=_||"",T[T.length-1]!==_&&(T.push(_),I=T.join(E),u.set(b,I))}else t.isDefined(_)&&null!==_?u.set(b,_):u.get(b)||u.set(b,"");break;case"variable":if(t.isDefined(S.name)){var x;l=S.exists,x=i.retrieveNestedVariable(o,S.name),t.isDefined(l)?u.get(b)!==l.success&&u.set(b,x?l.success:l.init):x?u.set(b,x):u.get(b)||u.set(b,S.init||"")}break;case"cookie":var R=a.get(S.val),P=t.isDefined(R);l=S.exists,t.isDefined(l)?u.get(b)!==l.success&&u.set(b,P?l.success:l.init):t.isDefined(R)&&null!==R?u.set(b,R):u.get(b)||u.set(b,S.init||"");break;case"url":for(var L=0,N=S.patterns.length;L<N;L++){var M=S.patterns[L].regex||S.patterns[L].match;y=S.patterns[L].value,t.isString(location.href)&&i.testAgainstSearch(M,location.href)?u.set(b,y):u.get(b)||u.set(b,S.init||"")}break;case"function":if(t.isFunction(S.value))try{y=S.value.call(o),u.set(b,y)}catch(e){}}else u.set(b,S)}}var O;if(c.get("ovr")&&(O=JSON.parse(c.get("ovr"))),O){for(var V=0;V<config.surveydefs.length;V++){var j=config.surveydefs[V].name;O.sp[j]&&(config.surveydefs[V].criteria.sp=O.sp[j]),O.lf[j]&&(config.surveydefs[V].criteria.lf=O.lf[j])}!0===O.pooloverride&&(f.pooloverride=!0)}if(r.state.codeVer=t.config.codeVer,r.state.siteKey=config.config.site_id,r.state.didInvite="xda".indexOf(p)>-1,r.state.inviteSituation={x:"ACCEPTED",d:"DECLINED",a:"ABANDONED",p:"PRESENTED"}[p],"a"==p){parseInt(c.get("rw"))<i.now()&&(c.erase("i"),c.erase("rw"),p=r.state.didInvite=null)}if("runRecordOnly"===config.config.workInIframes&&A){for(var B=!1,H=0;H<config.surveydefs.length;H++){if(config.surveydefs[H].cxRecord){B=!0;break}}return k(n,B,c,!0,u),void(r._triggerResetLock=!1)}if("d"!=p&&"a"!=p)f.calcReplayPoolStatus(function(o){o&&(r.state.isinpool=o),f.optoutCheck(t.proxy(function(){if(f._match(config.config,n,"globalExclude")&&"y"!=c.get("gx"))if(null===c.selectCookieDomain(t.config.cookieDomain,window.location.toString()))r._triggerResetLock=!1;else{var a=r.trig=D(c,config,n,f,u,d);if(a.logState(),u.set("pv",a.pageViewCount,config.config.pageViewsResetTimeout||864e5),a.init())if(r.initializedEmitter.fire(),a.doesPassCriteria())if(a.surveydef){if(a.logDefState(),k(n,a.surveydef.cxRecord,c,o,u),"x"!=p)if(n.isMobile||n.isTablet||!a.surveydef.mouseoff||"off"===a.surveydef.mouseoff.mode||1!=c.get("pv")||c.set("sst",i.now()),a.canDisplayInvitation())if(a.evalLoyaltySampling("criteria")){c.set("def",a.inviteIndex,a.cfg.config.surveyDefResetTimeout||864e5);g(a,n,c,u,!1,d,"Traditional",function(){this.initialize(),this.present()})}else c.get("sst")&&a.evalLoyaltySampling("mouseoff")?(c.set("def",a.inviteIndex,a.cfg.config.surveyDefResetTimeout||864e5),e([t.makeURI("$fs.mouseoff.js")],function(e){r._triggerResetLock=!1;var t=a.mouseoff=new e(a,a.surveydef,n,c,d);t.initialize(),t.startListening(function(){this.inviteSetup=g(a,n,c,u,!1,d,"MouseOff",function(){this.initialize()})},function(){this.inviteSetup.present()})}.bind(this))):r._triggerResetLock=!1;else r._triggerResetLock=!1;else{var l=a.stg.get("mhbi");l?h(a,l.ui,l.it):g(a,a.browser,a.stg,a.cpps,!1,a.jrny,"Traditional",function(){this.invite&&this.invite.display&&this.invite.template&&(a.tracker=new v(this.invite.template,a.surveydef,config,i.getBrainStorage(n,c.uid),u,this.invite.display,n))}),r._triggerResetLock=!1}a.surveydef.links&&(s=new w(a.surveydef.links),s.performBindings(a))}else r._triggerResetLock=!1;else r._triggerResetLock=!1;else r._triggerResetLock=!1}else c.set("gx","y"),r._triggerResetLock=!1},this),function(){r._triggerResetLock=!1})});else{if("a"==p){var U="true"==c.get("rc")||!0===c.get("rc");k(n,U,c,U,u)}r._triggerResetLock=!1}},this),Math.max(0,config.config.triggerDelay-(i.now()-t.startTS)))})},this),!0,!0)},!0,!0)};t.domReady(R);var P;config.config.ignoreNavigationEvents||i.pageNavEvent.subscribe(function(){var e=o,t=e.location,i=e[config.config.publicApiName||"FSR"],r=function(e){var t=e.split("#");return t.length>2?t[0]+t[1]:e.replace(/#/gi,"")},n=r(x.hash),s=r(t.hash);(i&&n!=s||x.pathname!=t.pathname)&&fsReady(function(){clearTimeout(P),P=setTimeout(function(){x={hash:o.location.hash,href:o.location.href,pathname:o.location.pathname},i.pageReset()},1e3)})},!1,!1)}});